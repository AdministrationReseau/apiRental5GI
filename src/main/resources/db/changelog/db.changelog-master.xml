<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.0.xsd">

    <!-- ChangeSet 1: Création table users -->
    <changeSet id="1" author="brayanne">
        <createTable tableName="users">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <!-- ChangeSet 2: Création table organizations -->
    <changeSet id="2" author="brayanne">
        <createTable tableName="organizations">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="owner_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_org_owner" referencedTableName="users" referencedColumnNames="id"/>
            </column>
        </createTable>
    </changeSet>

    <!-- ChangeSet 3: Création table audits (Oublié précédemment) -->
    <changeSet id="3" author="brayanne">
        <createTable tableName="audits">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="action" type="VARCHAR(255)"/>
            <column name="module" type="VARCHAR(255)"/>
            <column name="details" type="TEXT"/>
            <column name="timestamp" type="TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="4" author="brayanne">
        <addColumn tableName="users">
            <column name="firstname" type="VARCHAR(255)"/>
            <column name="lastname" type="VARCHAR(255)"/>
            <column name="fullname" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <!-- ChangeSet 5: Extension table organizations -->
    <changeSet id="5" author="brayanne">
        <addColumn tableName="organizations">
            <column name="description" type="TEXT"/>
            <column name="registration_number" type="VARCHAR(100)"/>
            <column name="tax_number" type="VARCHAR(100)"/>
            <column name="business_license" type="VARCHAR(500)"/> <!-- URL/Path du fichier -->
            <column name="address" type="VARCHAR(255)"/>
            <column name="city" type="VARCHAR(100)"/>
            <column name="country" type="VARCHAR(50)" defaultValue="CM"/>
            <column name="postal_code" type="VARCHAR(20)"/>
            <column name="region" type="VARCHAR(100)"/>
            <column name="phone" type="VARCHAR(50)"/>
            <column name="email" type="VARCHAR(255)"/>
            <column name="website" type="VARCHAR(255)"/>
            <column name="is_verified" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="verification_date" type="TIMESTAMP"/>
            <column name="current_agencies" type="INT" defaultValueNumeric="0"/>
            <column name="current_vehicles" type="INT" defaultValueNumeric="0"/>
            <column name="current_drivers" type="INT" defaultValueNumeric="0"/>
            <column name="current_users" type="INT" defaultValueNumeric="0"/>
            <column name="timezone" type="VARCHAR(50)" defaultValue="Africa/Douala"/>
            <column name="logo_url" type="VARCHAR(500)"/>
            <column name="subscription_plan_id" type="UUID"/>
            <column name="subscription_expires_at" type="TIMESTAMP"/>
            <column name="subscription_auto_renew" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="total_rentals" type="INT" defaultValueNumeric="0"/>
            <column name="monthly_revenue" type="DOUBLE" defaultValueNumeric="0.0"/>
            <column name="yearly_revenue" type="DOUBLE" defaultValueNumeric="0.0"/>
        </addColumn>
    </changeSet>

       <!-- 6. Table Subscriptions (Historique des transactions / Contrats) -->
    <changeSet id="6" author="hassana">
        <createTable tableName="subscriptions">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="organization_id" type="UUID">
                <constraints nullable="false" foreignKeyName="fk_subscription_org" referencedTableName="organizations" referencedColumnNames="id" deleteCascade="true"/>
            </column>
            <column name="plan_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="start_date" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="end_date" type="TIMESTAMP"/>
        </createTable>
    </changeSet>

    <!-- 7. Table des Plans de Souscription (Le Catalogue) -->
    <changeSet id="7-create-subscription-plans" author="hassana">
        <createTable tableName="subscription_plans">
            <column name="id" type="UUID" defaultValueComputed="gen_random_uuid()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(50)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="price" type="DECIMAL(19,2)">
                <constraints nullable="false"/>
            </column>
            <column name="duration_days" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="max_vehicles" type="INTEGER"/>
            <column name="max_drivers" type="INTEGER"/>
            <column name="max_agencies" type="INTEGER"/>
            <column name="max_users" type="INTEGER"/>
            <column name="has_geofencing" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="has_chat" type="BOOLEAN" defaultValueBoolean="false"/>
        </createTable>
    </changeSet>

     <!-- 8. Insertion des plans par défaut -->
    <changeSet id="8-seed-subscription-plans" author="hassana">
        <insert tableName="subscription_plans">
            <column name="name" value="FREE"/>
            <column name="description" value="Plan gratuit à vie"/>
            <column name="price" valueNumeric="0.00"/>
            <column name="duration_days" valueNumeric="0"/>
            <column name="max_vehicles" valueNumeric="5"/>
            <column name="max_drivers" valueNumeric="5"/>
            <column name="max_agencies" valueNumeric="1"/>
            <column name="max_users" valueNumeric="2"/>
        </insert>
        <insert tableName="subscription_plans">
            <column name="name" value="PRO"/>
            <column name="description" value="Plan professionnel 30 jours"/>
            <column name="price" valueNumeric="10000.00"/>
            <column name="duration_days" valueNumeric="30"/>
            <column name="max_vehicles" valueNumeric="50"/>
            <column name="max_drivers" valueNumeric="50"/>
            <column name="max_agencies" valueNumeric="10"/>
            <column name="max_users" valueNumeric="30"/>
            <column name="has_geofencing" valueBoolean="true"/>
            <column name="has_chat" valueBoolean="true"/>
        </insert>
        <insert tableName="subscription_plans">
            <column name="name" value="ENTERPRISE"/>
            <column name="description" value="Accès illimité à toutes les ressources (30 jours)"/>
            <column name="price" valueNumeric="30000.00"/>
            <column name="duration_days" valueNumeric="30"/>
            <column name="max_vehicles" valueNumeric="999999"/>
            <column name="max_drivers" valueNumeric="999999"/>
            <column name="max_agencies" valueNumeric="999999"/>
            <column name="max_users" valueNumeric="999999"/>
            <column name="has_geofencing" valueBoolean="true"/>
            <column name="has_chat" valueBoolean="true"/>
        </insert>
    </changeSet>

    <!-- 9. Ajustement de la table Organizations pour pointer vers l'ID du plan -->
    <changeSet id="9-update-org-subscription-link" author="hassana">
        <addForeignKeyConstraint baseTableName="organizations" baseColumnNames="subscription_plan_id" 
                                 constraintName="fk_org_sub_plan" referencedTableName="subscription_plans" 
                                 referencedColumnNames="id"/>
    </changeSet>

</databaseChangeLog>
