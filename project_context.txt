# Contexte du Projet : Fleet & Geofence API
GÃ©nÃ©rÃ© le : 12/27/2025 18:21:49
Framework : Spring Boot WebFlux (Reactive)

## 1. Arborescence du Projet

Structure du dossier pour le volume Nouveau nom
Le numÚro de sÚrie du volume est 30FA-23FE
D:.
ª   Dockerfile
ª   import_context_window.ps1
ª   pom.xml
ª   project_context.txt
ª   
ª   +---wrapper
ª           maven-wrapper.properties
ª           
ª       settings.json
ª       
+---src
ª   +---main
ª   ª   +---java
ª   ª   ª   +---com
ª   ª   ª       +---project
ª   ª   ª           +---apirental
ª   ª   ª               ª   ApirentalApplication.java
ª   ª   ª               ª   
ª   ª   ª               +---config
ª   ª   ª               ª       OpenApiConfig.java
ª   ª   ª               ª       SecurityConfig.java
ª   ª   ª               ª       
ª   ª   ª               +---modules
ª   ª   ª               ª   ª   explication.md
ª   ª   ª               ª   ª   
ª   ª   ª               ª   +---audit
ª   ª   ª               ª   ª   +---domain
ª   ª   ª               ª   ª   ª       AuditEntity.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---listener
ª   ª   ª               ª   ª   ª       AuditListener.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---repository
ª   ª   ª               ª   ª           AuditRepository.java
ª   ª   ª               ª   ª           
ª   ª   ª               ª   +---auth
ª   ª   ª               ª   ª   +---api
ª   ª   ª               ª   ª   ª       AuthController.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---domain
ª   ª   ª               ª   ª   ª       UserEntity.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---dto
ª   ª   ª               ª   ª   ª       AuthResponse.java
ª   ª   ª               ª   ª   ª       LoginRequest.java
ª   ª   ª               ª   ª   ª       RegisterRequest.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---listener
ª   ª   ª               ª   ª   ª       explication.md
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---mapper
ª   ª   ª               ª   ª   ª       UserMapper.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---repository
ª   ª   ª               ª   ª   ª       UserRepository.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---services
ª   ª   ª               ª   ª           AuthService.java
ª   ª   ª               ª   ª           
ª   ª   ª               ª   +---drivers
ª   ª   ª               ª   ª   +---api
ª   ª   ª               ª   ª   +---dto
ª   ª   ª               ª   ª   +---listener
ª   ª   ª               ª   ª   +---mapper
ª   ª   ª               ª   ª   +---repository
ª   ª   ª               ª   ª   +---services
ª   ª   ª               ª   +---media
ª   ª   ª               ª   ª   +---api
ª   ª   ª               ª   ª   ª       MediaController.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---config
ª   ª   ª               ª   ª   ª       MediaWebConfig.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---domain
ª   ª   ª               ª   ª   ª       MediaEntity.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---repository
ª   ª   ª               ª   ª   ª       MediaRepository.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---services
ª   ª   ª               ª   ª           MediaService.java
ª   ª   ª               ª   ª           
ª   ª   ª               ª   +---organization
ª   ª   ª               ª   ª   +---api
ª   ª   ª               ª   ª   ª       OrganizationController.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---domain
ª   ª   ª               ª   ª   ª       OrganizationEntity.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---dto
ª   ª   ª               ª   ª   ª       OrgRegisterRequest.java
ª   ª   ª               ª   ª   ª       OrgResponseDTO.java
ª   ª   ª               ª   ª   ª       OrgUpdateDTO.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---mapper
ª   ª   ª               ª   ª   ª       OrgMapper.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---repository
ª   ª   ª               ª   ª   ª       OrganizationRepository.java
ª   ª   ª               ª   ª   ª       
ª   ª   ª               ª   ª   +---services
ª   ª   ª               ª   ª           OrganizationService.java
ª   ª   ª               ª   ª           
ª   ª   ª               ª   +---subscription
ª   ª   ª               ª       +---api
ª   ª   ª               ª       ª       SubscriptionController.java
ª   ª   ª               ª       ª       
ª   ª   ª               ª       +---domain
ª   ª   ª               ª       ª       PlanType.java
ª   ª   ª               ª       ª       SubscriptionEntity.java
ª   ª   ª               ª       ª       SubscriptionPlanEntity.java
ª   ª   ª               ª       ª       
ª   ª   ª               ª       +---dto
ª   ª   ª               ª       ª       PlanUpgradeRequest.java
ª   ª   ª               ª       ª       SubscriptionRemainingTimeDTO.java
ª   ª   ª               ª       ª       SubscriptionResponseDTO.java
ª   ª   ª               ª       ª       
ª   ª   ª               ª       +---listener
ª   ª   ª               ª       ª       SubscriptionListener.java
ª   ª   ª               ª       ª       
ª   ª   ª               ª       +---mapper
ª   ª   ª               ª       ª       SubscriptionMapper.java
ª   ª   ª               ª       ª       
ª   ª   ª               ª       +---repository
ª   ª   ª               ª       ª       SubscriptionPlanRepository.java
ª   ª   ª               ª       ª       SubscriptionRepository.java
ª   ª   ª               ª       ª       
ª   ª   ª               ª       +---services
ª   ª   ª               ª               PaymentService.java
ª   ª   ª               ª               SubscriptionService.java
ª   ª   ª               ª               
ª   ª   ª               +---shared
ª   ª   ª                   +---config
ª   ª   ª                   ª       CorsConfig.java
ª   ª   ª                   ª       
ª   ª   ª                   +---events
ª   ª   ª                   ª       AuditEvent.java
ª   ª   ª                   ª       
ª   ª   ª                   +---exceptions
ª   ª   ª                   ª       GlobalExceptionHandler.java
ª   ª   ª                   ª       
ª   ª   ª                   +---security
ª   ª   ª                   ª       JwtAuthenticationFilter.java
ª   ª   ª                   ª       JwtUtil.java
ª   ª   ª                   ª       
ª   ª   ª                   +---utils
ª   ª   ª                           explication.md
ª   ª   ª                           
ª   ª   +---resources
ª   ª       ª   .env.example
ª   ª       ª   application.properties
ª   ª       ª   
ª   ª       +---db
ª   ª           +---changelog
ª   ª                   db.changelog-master.xml
ª   ª                   
ª   +---test
ª       +---java
ª           +---com
ª               +---project
ª                   +---apirental
ª                           ApirentalApplicationTests.java
ª                           
ª   +---classes
ª   ª   ª   .env.example
ª   ª   ª   application.properties
ª   ª   ª   
ª   ª   +---com
ª   ª   ª   +---project
ª   ª   ª       +---apirental
ª   ª   ª           ª   ApirentalApplication.class
ª   ª   ª           ª   
ª   ª   ª           +---config
ª   ª   ª           ª       OpenApiConfig.class
ª   ª   ª           ª       SecurityConfig.class
ª   ª   ª           ª       
ª   ª   ª           +---modules
ª   ª   ª           ª   ª   explication.md
ª   ª   ª           ª   ª   
ª   ª   ª           ª   +---audit
ª   ª   ª           ª   ª   +---domain
ª   ª   ª           ª   ª   ª       AuditEntity.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---listener
ª   ª   ª           ª   ª   ª       AuditListener.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---repository
ª   ª   ª           ª   ª           AuditRepository.class
ª   ª   ª           ª   ª           
ª   ª   ª           ª   +---auth
ª   ª   ª           ª   ª   +---api
ª   ª   ª           ª   ª   ª       AuthController.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---domain
ª   ª   ª           ª   ª   ª       UserEntity.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---dto
ª   ª   ª           ª   ª   ª       AuthResponse.class
ª   ª   ª           ª   ª   ª       LoginRequest.class
ª   ª   ª           ª   ª   ª       RegisterRequest.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---listener
ª   ª   ª           ª   ª   ª       explication.md
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---mapper
ª   ª   ª           ª   ª   ª       UserMapper.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---repository
ª   ª   ª           ª   ª   ª       UserRepository.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---services
ª   ª   ª           ª   ª           AuthService.class
ª   ª   ª           ª   ª           
ª   ª   ª           ª   +---drivers
ª   ª   ª           ª   ª   +---api
ª   ª   ª           ª   ª   +---dto
ª   ª   ª           ª   ª   +---listener
ª   ª   ª           ª   ª   +---mapper
ª   ª   ª           ª   ª   +---repository
ª   ª   ª           ª   ª   +---services
ª   ª   ª           ª   +---media
ª   ª   ª           ª   ª   +---api
ª   ª   ª           ª   ª   ª       MediaController$MediaResponse.class
ª   ª   ª           ª   ª   ª       MediaController.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---config
ª   ª   ª           ª   ª   ª       MediaWebConfig.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---domain
ª   ª   ª           ª   ª   ª       MediaEntity.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---repository
ª   ª   ª           ª   ª   ª       MediaRepository.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---services
ª   ª   ª           ª   ª           MediaService.class
ª   ª   ª           ª   ª           
ª   ª   ª           ª   +---organization
ª   ª   ª           ª   ª   +---api
ª   ª   ª           ª   ª   ª       OrganizationController.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---domain
ª   ª   ª           ª   ª   ª       OrganizationEntity.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---dto
ª   ª   ª           ª   ª   ª       OrgRegisterRequest.class
ª   ª   ª           ª   ª   ª       OrgResponseDTO.class
ª   ª   ª           ª   ª   ª       OrgUpdateDTO.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---mapper
ª   ª   ª           ª   ª   ª       OrgMapper.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---repository
ª   ª   ª           ª   ª   ª       OrganizationRepository.class
ª   ª   ª           ª   ª   ª       
ª   ª   ª           ª   ª   +---services
ª   ª   ª           ª   ª           OrganizationService.class
ª   ª   ª           ª   ª           
ª   ª   ª           ª   +---subscription
ª   ª   ª           ª       +---api
ª   ª   ª           ª       ª       SubscriptionController.class
ª   ª   ª           ª       ª       
ª   ª   ª           ª       +---domain
ª   ª   ª           ª       ª       PlanType.class
ª   ª   ª           ª       ª       SubscriptionEntity.class
ª   ª   ª           ª       ª       SubscriptionPlanEntity.class
ª   ª   ª           ª       ª       
ª   ª   ª           ª       +---dto
ª   ª   ª           ª       ª       PlanUpgradeRequest.class
ª   ª   ª           ª       ª       SubscriptionRemainingTimeDTO.class
ª   ª   ª           ª       ª       SubscriptionResponseDTO.class
ª   ª   ª           ª       ª       
ª   ª   ª           ª       +---listener
ª   ª   ª           ª       ª       SubscriptionListener.class
ª   ª   ª           ª       ª       
ª   ª   ª           ª       +---mapper
ª   ª   ª           ª       ª       SubscriptionMapper.class
ª   ª   ª           ª       ª       
ª   ª   ª           ª       +---repository
ª   ª   ª           ª       ª       SubscriptionPlanRepository.class
ª   ª   ª           ª       ª       SubscriptionRepository.class
ª   ª   ª           ª       ª       
ª   ª   ª           ª       +---services
ª   ª   ª           ª               PaymentService.class
ª   ª   ª           ª               SubscriptionService.class
ª   ª   ª           ª               
ª   ª   ª           +---shared
ª   ª   ª               +---config
ª   ª   ª               ª       CorsConfig.class
ª   ª   ª               ª       
ª   ª   ª               +---events
ª   ª   ª               ª       AuditEvent.class
ª   ª   ª               ª       
ª   ª   ª               +---exceptions
ª   ª   ª               ª       GlobalExceptionHandler$ErrorResponse.class
ª   ª   ª               ª       GlobalExceptionHandler.class
ª   ª   ª               ª       
ª   ª   ª               +---security
ª   ª   ª               ª       JwtAuthenticationFilter.class
ª   ª   ª               ª       JwtUtil.class
ª   ª   ª               ª       
ª   ª   ª               +---utils
ª   ª   ª                       explication.md
ª   ª   ª                       
ª   ª   +---db
ª   ª       +---changelog
ª   ª               db.changelog-master.xml
ª   ª               
ª   +---generated-sources
ª   ª   +---annotations
ª   +---generated-test-sources
ª   ª   +---test-annotations
ª   +---test-classes
ª       +---com
ª           +---project
ª               +---apirental
ª                       ApirentalApplicationTests.class
ª                       
+---uploads
        hzm_0c11eb35.md
        


## 2. Contenu des Fichiers

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\pom.xml
`$ext
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>3.4.12</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
	<groupId>com.project</groupId>
	<artifactId>apirental</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<name>apirental</name> 
	<description>api spring boot du projet rental</description>
	<url/>
	<licenses>
		<license/>
	</licenses>
	<developers>
		<developer/>
	</developers>
	<scm>
		<connection/>
		<developerConnection/>
		<tag/>
		<url/>
	</scm>
	<properties>
		<java.version>21</java.version>
        <!-- Ajout d'une propriÃ©tÃ© pour gÃ©rer la version de SpringDoc facilement -->
        <springdoc.version>2.7.0</springdoc.version>
	</properties>
	<dependencies>
		<!-- R2DBC (RÃ©actif) pour l'application -->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-r2dbc</artifactId>
		</dependency>
		<!-- PostgreSQL R2DBC Driver -->
		<dependency>
			<groupId>org.postgresql</groupId>
			<artifactId>r2dbc-postgresql</artifactId>
		</dependency>

		<!-- JDBC (Bloquant) pour Liquibase UNIQUEMENT -->
		<dependency>
			<groupId>org.postgresql</groupId>
			<artifactId>postgresql</artifactId>
			<scope>runtime</scope>
		</dependency>

		<!-- Liquibase -->
		<dependency>
			<groupId>org.liquibase</groupId>
			<artifactId>liquibase-core</artifactId>
		</dependency>

		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-validation</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-webflux</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-security</artifactId>
		</dependency>

        <!-- MISE A JOUR ICI : Version 2.7.0 pour compatibilitÃ© Spring Boot 3.4+ -->
		<dependency>
			<groupId>org.springdoc</groupId>
			<artifactId>springdoc-openapi-starter-webflux-ui</artifactId>
			<version>${springdoc.version}</version>
		</dependency>

		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-api</artifactId>
			<version>0.11.5</version>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-impl</artifactId>
			<version>0.11.5</version>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>io.jsonwebtoken</groupId>
			<artifactId>jjwt-jackson</artifactId>
			<version>0.11.5</version>
			<scope>runtime</scope>
		</dependency>

		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
		<dependency>
			<groupId>io.projectreactor</groupId>
			<artifactId>reactor-test</artifactId>
			<scope>test</scope>
		</dependency>
	</dependencies>

	<build>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<annotationProcessorPaths>
						<path>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</path>
					</annotationProcessorPaths>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
				<configuration>
					<excludes>
						<exclude>
							<groupId>org.projectlombok</groupId>
							<artifactId>lombok</artifactId>
						</exclude>
					</excludes>
				</configuration>
			</plugin>
		</plugins>
	</build>
</project>

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\.mvn\wrapper\maven-wrapper.properties
`$ext
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\ApirentalApplication.java
`$ext
package com.project.apirental;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.data.r2dbc.config.EnableR2dbcAuditing;
import org.springframework.scheduling.annotation.EnableAsync;

@SpringBootApplication
@EnableR2dbcAuditing // Active l'audit automatique pour R2DBC (dates de crÃ©ation, etc.)
@EnableAsync         // Indispensable pour que votre @Async dans AuditListener fonctionne
public class ApirentalApplication {

    public static void main(String[] args) {
        SpringApplication.run(ApirentalApplication.class, args);
    }

}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\config\OpenApiConfig.java
`$ext
package com.project.apirental.config;

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.security.SecurityScheme;
import io.swagger.v3.oas.models.security.SecurityRequirement;
import org.springdoc.core.models.GroupedOpenApi;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class OpenApiConfig {

    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
                .info(new Info().title("API Rental").version("1.0"))
                .addSecurityItem(new SecurityRequirement().addList("bearerAuth"))
                .components(new io.swagger.v3.oas.models.Components()
                        .addSecuritySchemes("bearerAuth",
                                new SecurityScheme().type(SecurityScheme.Type.HTTP).scheme("bearer").bearerFormat("JWT")));
    }

    // Groupe 1 : Auth (Public - Login/Register)
    @Bean
    public GroupedOpenApi authApi() {
        return GroupedOpenApi.builder()
                .group("1-authentification")
                .pathsToMatch("/auth/**", "/api/media/**")
                .build();
    }

    // Groupe 2 : Client (NÃ©cessite token)
    @Bean
    public GroupedOpenApi clientApi() {
        return GroupedOpenApi.builder()
                .group("2-client")
                .pathsToMatch("/api/client/**")
                .build();
    }

    // Groupe 3 : Organisation (NÃ©cessite token)
    @Bean
    public GroupedOpenApi orgApi() {
        return GroupedOpenApi.builder()
                .group("3-organization")
                .pathsToMatch("/api/org/**", "/api/subscriptions/**")
                .build();
    }

}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\config\SecurityConfig.java
`$ext
package com.project.apirental.config;

import com.project.apirental.shared.security.JwtAuthenticationFilter;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.http.HttpStatus;
import org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;
import org.springframework.security.config.web.server.SecurityWebFiltersOrder;
import org.springframework.security.config.web.server.ServerHttpSecurity;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.server.SecurityWebFilterChain;
import org.springframework.security.web.server.authentication.HttpStatusServerEntryPoint;

@Configuration
@EnableWebFluxSecurity
public class SecurityConfig {

    @Bean
    public SecurityWebFilterChain securityWebFilterChain(ServerHttpSecurity http, JwtAuthenticationFilter jwtFilter) {
        return http
                .csrf(ServerHttpSecurity.CsrfSpec::disable)
                .authorizeExchange(exchanges -> exchanges
                        .pathMatchers("/auth/**", "/swagger-ui.html", "/webjars/**", "/v3/api-docs/**").permitAll()
                        .pathMatchers("/api/subscriptions/plans/**").permitAll()
                        .pathMatchers(HttpMethod.PUT, "/api/subscriptions/plans/**").hasRole("ADMIN")
                        .pathMatchers("/api/org/**").hasRole("ORGANIZATION")
                        .pathMatchers("/uploads/**").permitAll()
                        .anyExchange().authenticated()
                )
                .exceptionHandling(exceptionHandlingSpec -> exceptionHandlingSpec
                        .authenticationEntryPoint(new HttpStatusServerEntryPoint(HttpStatus.UNAUTHORIZED))
                )
                .httpBasic(ServerHttpSecurity.HttpBasicSpec::disable)
                .formLogin(ServerHttpSecurity.FormLoginSpec::disable)
                .addFilterAt(jwtFilter, SecurityWebFiltersOrder.AUTHENTICATION) // Ajout du filtre JWT
                .build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\explication.md
`$ext
#### notre architecture est une architecture modulaire tous les differents module sont implementÃ©s mais chacun dans son dossier permttant ainsi de les exporter facilement dans d'autres projets afin de transformer ce projet en microservice pour une evolution de celui-ci 

##### Dans le module auth j'ai mis toute la structure generale d'un module mais pour les module tous les dossiers ne sont pas forcement necessaire comme exemple les module comme la gestion des logs qui necessite les listener pour ecouter chaque evenement du syteme ou meme celui de notifications qui ne necessite pas forcement tous les dossier 

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\audit\domain\AuditEntity.java
`$ext
package com.project.apirental.modules.audit.domain;

import com.fasterxml.jackson.annotation.JsonIgnore;
import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.Transient;
import org.springframework.data.domain.Persistable;
import org.springframework.data.relational.core.mapping.Table;
import lombok.Data;
import lombok.Builder;
import lombok.AllArgsConstructor;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;
import java.util.UUID;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table("audits")
public class AuditEntity implements Persistable<UUID> {
    @Id
    private UUID id;
    private String action;
    private String module;
    private String details;
    private LocalDateTime timestamp;

    @Transient
    @Builder.Default
    @JsonIgnore
    private boolean isNewRecord = false;

    @Override
    @Transient
    public boolean isNew() {
        return isNewRecord || id == null;
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\audit\listener\AuditListener.java
`$ext
package com.project.apirental.modules.audit.listener;

import com.project.apirental.modules.audit.domain.AuditEntity;
import com.project.apirental.modules.audit.repository.AuditRepository;
import com.project.apirental.shared.events.AuditEvent;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.event.EventListener;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Component;
import java.time.LocalDateTime;
import java.util.UUID;

@Component
@RequiredArgsConstructor
@Slf4j
public class AuditListener {

    private final AuditRepository auditRepository;

    @EventListener
    @Async
    public void handleAuditEvent(AuditEvent event) {
        AuditEntity audit = AuditEntity.builder()
                .id(UUID.randomUUID())
                .action(event.action())
                .module(event.module())
                .details(event.details())
                .timestamp(LocalDateTime.now())
                .isNewRecord(true) // <--- IMPORTANT : Force l'INSERT
                .build();

        if (audit != null) {
            auditRepository.save(audit)
                    .doOnError(e -> log.error("Erreur lors de l'enregistrement de l'audit: {}", e.getMessage()))
                    .subscribe(); // Fire-and-forget
}
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\audit\repository\AuditRepository.java
`$ext
package com.project.apirental.modules.audit.repository;

import com.project.apirental.modules.audit.domain.AuditEntity;

import java.util.UUID;

import org.springframework.data.r2dbc.repository.R2dbcRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface AuditRepository extends R2dbcRepository<AuditEntity, UUID> {
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\auth\api\AuthController.java
`$ext
package com.project.apirental.modules.auth.api;

import com.project.apirental.modules.auth.domain.UserEntity;
import com.project.apirental.modules.auth.dto.*;
import com.project.apirental.modules.auth.services.AuthService;
import com.project.apirental.modules.organization.domain.OrganizationEntity;
import com.project.apirental.modules.organization.dto.OrgRegisterRequest;

import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Mono;
import org.springframework.http.HttpHeaders;
import org.springframework.web.server.ServerWebExchange;

@RestController
@RequestMapping("/auth")
@RequiredArgsConstructor
public class AuthController {

    private final AuthService authService;

    @PostMapping("/login")
    public Mono<ResponseEntity<AuthResponse>> login(@RequestBody LoginRequest request) {
        return authService.login(request).map(ResponseEntity::ok);
    }

    // RÃ©cupÃ©rer l'utilisateur connectÃ©
    @GetMapping("/me")
    public Mono<ResponseEntity<UserEntity>> me() {
        return authService.getCurrentUser()
                .map(ResponseEntity::ok);
    }

    // RafraÃ®chir le token
    @PostMapping("/refresh")
    public Mono<ResponseEntity<AuthResponse>> refresh(ServerWebExchange exchange) {
        String authHeader = exchange.getRequest().getHeaders().getFirst(HttpHeaders.AUTHORIZATION);
        return authService.refreshToken(authHeader)
                .map(ResponseEntity::ok);
    }

    @PostMapping("/register/client")
    public Mono<ResponseEntity<UserEntity>> registerClient(@RequestBody RegisterRequest request) {
        return authService.registerClient(request)
                .map(ResponseEntity::ok);
    }

    @PostMapping("/register/organizationOwner")
    public Mono<ResponseEntity<OrganizationEntity>> registerOrganization(@RequestBody OrgRegisterRequest request) {
        return authService.registerOrganization(request)
                .map(ResponseEntity::ok);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\auth\domain\UserEntity.java
`$ext
package com.project.apirental.modules.auth.domain;

import java.util.UUID;

import com.fasterxml.jackson.annotation.JsonIgnore;
import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.Transient;
import org.springframework.data.domain.Persistable;
import org.springframework.data.relational.core.mapping.Table;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table("users")
public class UserEntity implements Persistable<UUID> {
    @Id
    private UUID id;
    private String firstname;
    private String lastname;
    private String fullname;
    private String email;
    private String password;
    private String role;

    // Champ technique pour indiquer Ã  R2DBC si c'est un INSERT ou UPDATE
    @Transient
    @Builder.Default
    @JsonIgnore
    private boolean isNewRecord = false;

    @Override
    @Transient
    public boolean isNew() {
        // Si isNewRecord est true OU si l'id est null, c'est un INSERT
        return isNewRecord || id == null;
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\auth\dto\AuthResponse.java
`$ext
package com.project.apirental.modules.auth.dto;

public record AuthResponse(String token) {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\auth\dto\LoginRequest.java
`$ext
package com.project.apirental.modules.auth.dto;

public record LoginRequest(String email, String password) {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\auth\dto\RegisterRequest.java
`$ext
package com.project.apirental.modules.auth.dto;

public record RegisterRequest(
    String firstname,
    String lastname,
    String email,
    String password) {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\auth\listener\explication.md
`$ext
#### Cette dossier a pour but de mettre les fichier lie a la logique d'ecoute pour les entites qui en ont besoin cela dans l'utilisation du design pattern observer mais dans ce cas il n'est pas necessaire 

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\auth\mapper\UserMapper.java
`$ext
package com.project.apirental.modules.auth.mapper;


public interface UserMapper {
    // UserDTO toDto(UserEntity entity);
    // UserEntity toEntity(UserDTO dto);
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\auth\repository\UserRepository.java
`$ext
package com.project.apirental.modules.auth.repository;

import java.util.UUID;

import com.project.apirental.modules.auth.domain.UserEntity;
import org.springframework.data.r2dbc.repository.R2dbcRepository;
import reactor.core.publisher.Mono;

public interface UserRepository extends R2dbcRepository<UserEntity, UUID> {
    Mono<UserEntity> findByEmail(String email);
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\auth\services\AuthService.java
`$ext
package com.project.apirental.modules.auth.services;

import com.project.apirental.modules.auth.domain.UserEntity;
import com.project.apirental.modules.auth.dto.*;
import com.project.apirental.modules.organization.dto.OrgRegisterRequest;
import com.project.apirental.modules.auth.repository.UserRepository;
import com.project.apirental.modules.organization.domain.OrganizationEntity;
import com.project.apirental.modules.organization.repository.OrganizationRepository;
import com.project.apirental.modules.subscription.domain.SubscriptionEntity;
import com.project.apirental.modules.subscription.repository.SubscriptionPlanRepository;
import com.project.apirental.modules.subscription.repository.SubscriptionRepository;
import com.project.apirental.modules.subscription.services.SubscriptionService;
import com.project.apirental.shared.events.AuditEvent;
import com.project.apirental.shared.security.JwtUtil;
import lombok.RequiredArgsConstructor;

import java.time.LocalDateTime;
import java.util.UUID;

import org.springframework.context.ApplicationEventPublisher;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import reactor.core.publisher.Mono;
import org.springframework.security.core.context.ReactiveSecurityContextHolder;

@Service
@RequiredArgsConstructor
public class AuthService {

    private final UserRepository userRepository;
    private final OrganizationRepository orgRepository;
    private final SubscriptionPlanRepository planRepository; 
    private final SubscriptionRepository subscriptionRepository;
    private final SubscriptionService subscriptionService;
    private final PasswordEncoder passwordEncoder;
    private final JwtUtil jwtUtil;
    private final ApplicationEventPublisher eventPublisher;

    // Authentification (Login)
    public Mono<AuthResponse> login(LoginRequest request) {
        return userRepository.findByEmail(request.email())
                .filter(u -> passwordEncoder.matches(request.password(), u.getPassword()))
                .map(u -> {
                    // Audit de succÃ¨s
                    eventPublisher.publishEvent(new AuditEvent("LOGIN", "AUTH", "User logged in: " + u.getEmail()));
                    return new AuthResponse(jwtUtil.generateToken(u.getEmail(), u.getRole()));
                })
                .switchIfEmpty(Mono.error(new RuntimeException("Bad credentials")));
    }

    // Nouvelle mÃ©thode : RÃ©cupÃ©rer l'utilisateur courant via le contexte de sÃ©curitÃ©
    public Mono<UserEntity> getCurrentUser() {
        return ReactiveSecurityContextHolder.getContext()
                .map(ctx -> ctx.getAuthentication().getName())
                .flatMap(userRepository::findByEmail);
    }

    // Nouvelle mÃ©thode : Refresh Token
    public Mono<AuthResponse> refreshToken(String oldToken) {
        if (oldToken.startsWith("Bearer ")) {
            oldToken = oldToken.substring(7);
        }

        if (jwtUtil.validateToken(oldToken)) {
            String email = jwtUtil.getUsernameFromToken(oldToken);
            return userRepository.findByEmail(email)
                    .map(user -> new AuthResponse(jwtUtil.generateToken(user.getEmail(), user.getRole())));
        }
        return Mono.error(new RuntimeException("Invalid Token"));
    }

    // Inscription Client Simple
    public Mono<UserEntity> registerClient(RegisterRequest request) {
        return userRepository.findByEmail(request.email())
                .flatMap(existing -> Mono.error(new RuntimeException("Email already exists")))
                .switchIfEmpty(Mono.defer(() -> {
                    UserEntity user = UserEntity.builder()
                            .id(UUID.randomUUID())
                            .firstname(request.firstname())
                            .lastname(request.lastname())
                            .fullname(request.firstname() +" "+ request.lastname())
                            .email(request.email())
                            .password(passwordEncoder.encode(request.password()))
                            .role("CLIENT")
                            .isNewRecord(true) // <--- IMPORTANT : Force l'INSERT
                            .build();
                    return userRepository.save(user)
                            .doOnSuccess(u -> eventPublisher.publishEvent(new AuditEvent("REGISTER_CLIENT", "AUTH", "New client: " + u.getEmail())));
                })).cast(UserEntity.class);
    }

    // ScÃ©nario Organisation: CrÃ©ation User + CrÃ©ation Org
    @Transactional
    public Mono<OrganizationEntity> registerOrganization(OrgRegisterRequest request) {
        return userRepository.findByEmail(request.email())
                .flatMap(existing -> Mono.<OrganizationEntity>error(new RuntimeException("Email already exists")))
                .switchIfEmpty(Mono.defer(() -> 
                    // 1. On cherche d'abord le plan FREE
                    planRepository.findByName("FREE")
                        .switchIfEmpty(Mono.error(new RuntimeException("Plan FREE non configurÃ© en base")))
                        .flatMap(freePlan -> {
                            
                            // 2. CrÃ©er le User
                            UserEntity user = UserEntity.builder()
                                    .id(UUID.randomUUID())
                                    .firstname(request.firstname())
                                    .lastname(request.lastname())
                                    .fullname(request.firstname() + " " + request.lastname())
                                    .email(request.email())
                                    .password(passwordEncoder.encode(request.password()))
                                    .role("ORGANIZATION")
                                    .isNewRecord(true)
                                    .build();

                            return userRepository.save(user).flatMap(savedUser -> {
                                
                                // 3. CrÃ©er l'Organisation AVEC le plan ID dÃ©jÃ  prÃ©sent
                                OrganizationEntity org = OrganizationEntity.builder()
                                        .id(UUID.randomUUID())
                                        .name(request.orgName())
                                        .ownerId(savedUser.getId())
                                        .email(savedUser.getEmail())
                                        .country("CM")
                                        .timezone("Africa/Douala")
                                        .subscriptionPlanId(freePlan.getId()) // <--- FIX : InjectÃ© ici
                                        .subscriptionAutoRenew(true)
                                        .isVerified(false)
                                        .isNewRecord(true)
                                        .build();

                                return orgRepository.save(org)
                                        .flatMap(savedOrg -> 
                                            // 4.APPEL AU SERVICE : Remplir la table subscriptions (historique)
                                            subscriptionService.createHistoryRecord(savedOrg.getId(), freePlan.getName(), null)
                                                .thenReturn(savedOrg) // On retourne l'organisation finale
                                        )
                                        .doOnSuccess(o -> eventPublisher.publishEvent(
                                            new AuditEvent("REGISTER_ORG", "AUTH", "New Org: " + o.getName() + " with plan FREE")
                                        ));
                            });
                        })
                ));
    }

  
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\media\api\MediaController.java
`$ext
package com.project.apirental.modules.media.api;

import com.project.apirental.modules.media.services.MediaService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.http.codec.multipart.FilePart;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Mono;

@RestController
@RequestMapping("/api/media")
@RequiredArgsConstructor
@Tag(name = "Media Management", description = "Upload de fichiers pour Clients et Organisations")
@SecurityRequirement(name = "bearerAuth")
public class MediaController {

    private final MediaService mediaService;

    @Operation(summary = "Upload d'un fichier (Image, Doc, etc.)")
    @PostMapping(value = "/upload", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public Mono<ResponseEntity<MediaResponse>> upload(@RequestPart("file") FilePart file) {
        return mediaService.uploadFile(file)
                .map(media -> ResponseEntity.ok(new MediaResponse(media.getFileUrl(), media.getFilename())));
    }

    // DTO simple pour la rÃ©ponse
    public record MediaResponse(String url, String filename) {}
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\media\config\MediaWebConfig.java
`$ext
package com.project.apirental.modules.media.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.CacheControl;
import org.springframework.web.reactive.config.ResourceHandlerRegistry;
import org.springframework.web.reactive.config.WebFluxConfigurer;

import java.nio.file.Paths;
import java.util.concurrent.TimeUnit;

@Configuration
public class MediaWebConfig implements WebFluxConfigurer {

    @Value("${application.file.upload-dir:uploads}")
    private String uploadDir;

    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        // Expose le dossier local "uploads" via l'URL "/uploads/**"
        String absolutePath = Paths.get(uploadDir).toAbsolutePath().toUri().toString();

        registry.addResourceHandler("/uploads/**")
                .addResourceLocations(absolutePath)
                .setCacheControl(CacheControl.maxAge(365, TimeUnit.DAYS));
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\media\domain\MediaEntity.java
`$ext
package com.project.apirental.modules.media.domain;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.Transient;
import org.springframework.data.domain.Persistable;
import org.springframework.data.relational.core.mapping.Table;

import java.time.LocalDateTime;
import java.util.UUID;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table("medias")
public class MediaEntity implements Persistable<UUID> {

    @Id
    private UUID id;
    private String filename;
    private String originalFilename;
    private String fileType;
    private String fileUrl;
    private UUID uploaderId;
    private LocalDateTime createdAt;

    @Transient
    @Builder.Default
    private boolean isNewRecord = false;

    @Override
    @Transient
    public boolean isNew() {
        return isNewRecord || id == null;
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\media\repository\MediaRepository.java
`$ext
package com.project.apirental.modules.media.repository;

import com.project.apirental.modules.media.domain.MediaEntity;
import org.springframework.data.r2dbc.repository.R2dbcRepository;
import org.springframework.stereotype.Repository;

import java.util.UUID;

@Repository
public interface MediaRepository extends R2dbcRepository<MediaEntity, UUID> {
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\media\services\MediaService.java
`$ext
package com.project.apirental.modules.media.services;

import com.project.apirental.modules.auth.repository.UserRepository;
import com.project.apirental.modules.media.domain.MediaEntity;
import com.project.apirental.modules.media.repository.MediaRepository;
import com.project.apirental.modules.organization.repository.OrganizationRepository;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.codec.multipart.FilePart;
import org.springframework.security.core.context.ReactiveSecurityContextHolder;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;

import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.util.UUID;

@Service
@RequiredArgsConstructor
@Slf4j
public class MediaService {

    @Value("${application.file.upload-dir:uploads}")
    private String uploadDir;

    // UtilisÃ© pour construire l'URL complÃ¨te si besoin, sinon on renvoie le chemin relatif
    @Value("${application.base-url:http://localhost:8080}")
    private String baseUrl;

    private final MediaRepository mediaRepository;
    private final UserRepository userRepository;
    private final OrganizationRepository organizationRepository;

    // CrÃ©e le dossier au dÃ©marrage si inexistant
    @PostConstruct
    public void init() {
        try {
            Files.createDirectories(Paths.get(uploadDir));
        } catch (Exception e) {
            throw new RuntimeException("Impossible de crÃ©er le dossier d'upload", e);
        }
    }

    public Mono<MediaEntity> uploadFile(FilePart filePart) {
        return ReactiveSecurityContextHolder.getContext()
                .map(ctx -> ctx.getAuthentication().getName()) // RÃ©cupÃ¨re l'email
                .flatMap(email -> userRepository.findByEmail(email))
                .flatMap(user -> {
                    // Logique de nommage
                    Mono<String> prefixMono;

                    if ("ORGANIZATION".equals(user.getRole())) {
                        // Si c'est une ORG, on cherche son nom
                        prefixMono = organizationRepository.findByOwnerId(user.getId()) // MÃ©thode Ã  ajouter dans OrgRepo*
                                .map(org -> sanitizeFilename(org.getName()))
                                .defaultIfEmpty("org_" + user.getId());
                    } else {
                        // Si c'est un CLIENT, on utilise son ID ou nom
                        prefixMono = Mono.just("user_" + sanitizeFilename(user.getLastname()));
                    }

                    return prefixMono.flatMap(prefix -> {
                        // Construction du nom unique
                        String extension = getFileExtension(filePart.filename());
                        String uniqueName = prefix + "_" + UUID.randomUUID().toString().substring(0, 8) + extension;
                        Path destinationFile = Paths.get(uploadDir).resolve(uniqueName).toAbsolutePath();

                        // URL Publique
                        String publicUrl = baseUrl + "/uploads/" + uniqueName;

                        // Sauvegarde physique + Base de donnÃ©es
                        return filePart.transferTo(destinationFile)
                                .then(saveMediaEntity(filePart, uniqueName, publicUrl, user.getId()));
                    });
                });
    }

    private Mono<MediaEntity> saveMediaEntity(FilePart filePart, String filename, String url, UUID uploaderId) {
        MediaEntity media = MediaEntity.builder()
                .id(UUID.randomUUID())
                .filename(filename)
                .originalFilename(filePart.filename())
                .fileType(filePart.headers().getContentType() != null ? filePart.headers().getContentType().toString() : "application/octet-stream")
                .fileUrl(url)
                .uploaderId(uploaderId)
                .createdAt(LocalDateTime.now())
                .isNewRecord(true)
                .build();

        return mediaRepository.save(media);
    }

    // Utilitaires
    private String sanitizeFilename(String input) {
        return input.replaceAll("[^a-zA-Z0-9]", "_").toLowerCase();
    }

    private String getFileExtension(String filename) {
        int lastDotIndex = filename.lastIndexOf(".");
        return (lastDotIndex != -1) ? filename.substring(lastDotIndex) : "";
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\organization\api\OrganizationController.java
`$ext
package com.project.apirental.modules.organization.api;

import com.project.apirental.modules.organization.dto.OrgResponseDTO;
import com.project.apirental.modules.organization.dto.OrgUpdateDTO;
import com.project.apirental.modules.organization.mapper.OrgMapper;
import com.project.apirental.modules.organization.repository.OrganizationRepository;
import com.project.apirental.modules.organization.services.OrganizationService;
import com.project.apirental.modules.subscription.dto.PlanUpgradeRequest;
import com.project.apirental.modules.subscription.dto.SubscriptionRemainingTimeDTO;
import com.project.apirental.modules.subscription.dto.SubscriptionResponseDTO;
import com.project.apirental.modules.subscription.mapper.SubscriptionMapper;
import com.project.apirental.modules.subscription.repository.SubscriptionPlanRepository;
import com.project.apirental.modules.subscription.services.SubscriptionService;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;

import java.util.UUID;

import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

@RestController
@RequestMapping("/api/org")
@RequiredArgsConstructor
@Tag(name = "Organization Management", description = "Endpoints pour la gestion des organisations")
@SecurityRequirement(name = "bearerAuth") // Indique Ã  Swagger que ces routes nÃ©cessitent un token
public class OrganizationController {

    private final OrganizationService organizationService;
    private final OrganizationRepository organizationRepository;
    private final OrgMapper orgMapper;

     private final SubscriptionService subscriptionService;
    private final SubscriptionPlanRepository planRepository;
    private final SubscriptionMapper subscriptionMapper;

    @Operation(summary = "Obtenir les dÃ©tails d'une organisation")
    @GetMapping("/{id}")
    @PreAuthorize("hasRole('ORGANIZATION')") // Protection par RÃ´le
    public Mono<ResponseEntity<OrgResponseDTO>> getOrganization(@PathVariable UUID id) {
        return organizationService.getOrganization(id)
                .map(ResponseEntity::ok);
    }

    @Operation(summary = "Mettre Ã  jour une organisation")
    @PutMapping("/{id}")
    @PreAuthorize("hasRole('ORGANIZATION')") // Protection par RÃ´le
    public Mono<ResponseEntity<OrgResponseDTO>> updateOrganization(
            @PathVariable UUID id,
            @RequestBody OrgUpdateDTO request) {
        return organizationService.updateOrganization(id, request)
                .map(ResponseEntity::ok);
    }

    @Operation(summary = "Lister les organisations par ID de plan de souscription")
    @GetMapping("/plan/{planId}")
    @PreAuthorize("hasRole('ORGANIZATION')")
    public Flux<OrgResponseDTO> getOrganizationsByPlan(@PathVariable UUID planId) {
        return organizationRepository.findAllBySubscriptionPlanId(planId)
                .map(orgMapper::toDto);
    }
    @Operation(summary = "Statut de l'abonnement de cette organisation")
    @GetMapping("/{id}/subscription")
    @PreAuthorize("hasRole('ORGANIZATION')")
    public Mono<ResponseEntity<SubscriptionResponseDTO>> getOrgSubscriptionStatus(@PathVariable UUID id) {
        return organizationRepository.findById(id)
                .flatMap(subscriptionService::checkAndDowngrade)
                .flatMap(org -> planRepository.findById(org.getSubscriptionPlanId())
                        .map(plan -> subscriptionMapper.toResponseDTO(org, plan)))
                .map(ResponseEntity::ok);
    }

    @Operation(summary = "Temps restant avant expiration")
    @GetMapping("/{id}/subscription/remaining")
    @PreAuthorize("hasRole('ORGANIZATION')")
    public Mono<ResponseEntity<SubscriptionRemainingTimeDTO>> getRemainingTime(@PathVariable UUID id) {
        return subscriptionService.getRemainingTime(id).map(ResponseEntity::ok);
    }

    @Operation(summary = "Upgrade du plan de l'organisation")
    @PutMapping("/{id}/subscription/upgrade")
    @PreAuthorize("hasRole('ORGANIZATION')")
    public Mono<ResponseEntity<SubscriptionResponseDTO>> upgradePlan(
            @PathVariable UUID id,
            @RequestBody PlanUpgradeRequest request) {
        return subscriptionService.upgradePlan(id, request.newPlan().name())
                .flatMap(updatedPlan -> organizationRepository.findById(id)
                        .map(org -> subscriptionMapper.toResponseDTO(org, updatedPlan)))
                .map(ResponseEntity::ok);
    }

}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\organization\domain\OrganizationEntity.java
`$ext
package com.project.apirental.modules.organization.domain;

import java.time.LocalDateTime;
import java.util.UUID;

import com.fasterxml.jackson.annotation.JsonIgnore;
import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.Transient;
import org.springframework.data.domain.Persistable;
import org.springframework.data.relational.core.mapping.Table;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table("organizations")
public class OrganizationEntity implements Persistable<UUID> {
    @Id
    private UUID id;
    private String name;
    private String description;
    private UUID ownerId;

    // Legal & Business
    private String registrationNumber;
    private String taxNumber;
    private String businessLicense; // Path to file or URL

    // Contact & Location
    private String address;
    private String city;
    @Builder.Default
    private String country = "CM";
    private String postalCode;
    private String region;
    private String phone;
    private String email;
    private String website;

    // Status
    @Builder.Default
    private Boolean isVerified = false;
    private LocalDateTime verificationDate;

    // Metrics (Counters)
    @Builder.Default
    private Integer currentAgencies = 0;
    @Builder.Default
    private Integer currentVehicles = 0;
    @Builder.Default
    private Integer currentDrivers = 0;
    @Builder.Default
    private Integer currentUsers = 0;

    // Settings
    @Builder.Default
    private String timezone = "Africa/Douala";
    private String logoUrl;

    // Subscription
    private UUID subscriptionPlanId; 
    private LocalDateTime subscriptionExpiresAt;
    @Builder.Default
    private Boolean subscriptionAutoRenew = true;

    // Financial Metrics
    @Builder.Default
    private Integer totalRentals = 0;
    @Builder.Default
    private Double monthlyRevenue = 0.0;
    @Builder.Default
    private Double yearlyRevenue = 0.0;

    @Transient
    @Builder.Default
    @JsonIgnore
    private boolean isNewRecord = false;

    @Override
    @Transient
    public boolean isNew() {
        return isNewRecord || id == null;
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\organization\dto\OrgRegisterRequest.java
`$ext
package com.project.apirental.modules.organization.dto;

public record OrgRegisterRequest(String firstname, String lastname, String email, String password, String orgName) {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\organization\dto\OrgResponseDTO.java
`$ext
package com.project.apirental.modules.organization.dto;
import java.time.LocalDateTime;
import java.util.UUID;
public record OrgResponseDTO(
    UUID id,
    String name,
    String description,
    UUID ownerId,
    String registrationNumber,
    String taxNumber,
    String businessLicense,
    String address,
    String city,
    String country,
    String postalCode,
    String region,
    String phone,
    String email,
    String website,
    Boolean isVerified,
    LocalDateTime verificationDate,
    Integer currentAgencies,
    Integer currentVehicles,
    Integer currentDrivers,
    String timezone,
    String logoUrl,
    UUID subscriptionPlanId,
    LocalDateTime subscriptionExpiresAt,
    Integer totalRentals,
    Double monthlyRevenue,
    Double yearlyRevenue
) {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\organization\dto\OrgUpdateDTO.java
`$ext
package com.project.apirental.modules.organization.dto;
// DTO utilisÃ© pour mettre Ã  jour les informations Ã©ditables par l'utilisateur
public record OrgUpdateDTO(
    String name,
    String description,
    String address,
    String city,
    String postalCode,
    String region,
    String phone,
    String email,
    String website,
    String timezone,
    String logoUrl,
    String registrationNumber,
    String taxNumber
) {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\organization\mapper\OrgMapper.java
`$ext
package com.project.apirental.modules.organization.mapper;

import com.project.apirental.modules.organization.domain.OrganizationEntity;
import com.project.apirental.modules.organization.dto.OrgResponseDTO;
import org.springframework.stereotype.Component;

@Component
public class OrgMapper {

    public OrgResponseDTO toDto(OrganizationEntity entity) {
        if (entity == null) return null;
        return new OrgResponseDTO(
            entity.getId(),
            entity.getName(),
            entity.getDescription(),
            entity.getOwnerId(),
            entity.getRegistrationNumber(),
            entity.getTaxNumber(),
            entity.getBusinessLicense(),
            entity.getAddress(),
            entity.getCity(),
            entity.getCountry(),
            entity.getPostalCode(),
            entity.getRegion(),
            entity.getPhone(),
            entity.getEmail(),
            entity.getWebsite(),
            entity.getIsVerified(),
            entity.getVerificationDate(),
            entity.getCurrentAgencies(),
            entity.getCurrentVehicles(),
            entity.getCurrentDrivers(),
            entity.getTimezone(),
            entity.getLogoUrl(),
            entity.getSubscriptionPlanId(),
            entity.getSubscriptionExpiresAt(),
            entity.getTotalRentals(),
            entity.getMonthlyRevenue(),
            entity.getYearlyRevenue()
        );
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\organization\repository\OrganizationRepository.java
`$ext
package com.project.apirental.modules.organization.repository;

import com.project.apirental.modules.organization.domain.OrganizationEntity;

import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

import org.springframework.data.r2dbc.repository.R2dbcRepository;

public interface OrganizationRepository extends R2dbcRepository<OrganizationEntity, UUID> {
    Flux<OrganizationEntity> findAllBySubscriptionPlanId(UUID subscriptionPlanId);
    Mono<OrganizationEntity> findByOwnerId(UUID ownerId);
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\organization\services\OrganizationService.java
`$ext
package com.project.apirental.modules.organization.services;

import com.project.apirental.modules.organization.dto.OrgResponseDTO;
import com.project.apirental.modules.organization.dto.OrgUpdateDTO;
import com.project.apirental.modules.organization.mapper.OrgMapper;
import com.project.apirental.modules.organization.repository.OrganizationRepository;
import com.project.apirental.shared.events.AuditEvent;
import lombok.RequiredArgsConstructor;

import java.util.UUID;

import org.springframework.context.ApplicationEventPublisher;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import reactor.core.publisher.Mono;

@Service
@RequiredArgsConstructor
public class OrganizationService {

    private final OrganizationRepository organizationRepository;
    private final OrgMapper orgMapper;
    private final ApplicationEventPublisher eventPublisher;

    public Mono<OrgResponseDTO> getOrganization(UUID id) {
        if (id == null) {
            return Mono.error(new IllegalArgumentException("id must not be null"));
        }
        return organizationRepository.findById(id)
                .map(orgMapper::toDto)
                .switchIfEmpty(Mono.error(new RuntimeException("Organization not found")));
    }

    @Transactional
    public Mono<OrgResponseDTO> updateOrganization(UUID id, OrgUpdateDTO request) {
        if (id == null) {
            return Mono.error(new IllegalArgumentException("id must not be null"));
        }
        return organizationRepository.findById(id)
            .flatMap(org -> {
                // Mapping manuel (ou via MapStruct si configurÃ© plus tard)
                if(request.name() != null) org.setName(request.name());
                if(request.description() != null) org.setDescription(request.description());
                if(request.address() != null) org.setAddress(request.address());
                if(request.city() != null) org.setCity(request.city());
                if(request.postalCode() != null) org.setPostalCode(request.postalCode());
                if(request.region() != null) org.setRegion(request.region());
                if(request.phone() != null) org.setPhone(request.phone());
                if(request.email() != null) org.setEmail(request.email());
                if(request.website() != null) org.setWebsite(request.website());
                if(request.timezone() != null) org.setTimezone(request.timezone());
                if(request.logoUrl() != null) org.setLogoUrl(request.logoUrl());
                if(request.registrationNumber() != null) org.setRegistrationNumber(request.registrationNumber());
                if(request.taxNumber() != null) org.setTaxNumber(request.taxNumber());

                if (org != null) {
                    return organizationRepository.save(org)
                        .doOnSuccess(updatedOrg -> {
                            eventPublisher.publishEvent(new AuditEvent(
                                "UPDATE_ORG",
                                "ORGANIZATION",
                                "Updated organization: " + updatedOrg.getName()
                            ));
                        });
                } else {
                    return Mono.error(new IllegalArgumentException("org must not be null"));
                }
            })
            .map(orgMapper::toDto)
            .switchIfEmpty(Mono.error(new RuntimeException("Organization not found")));
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\subscription\api\SubscriptionController.java
`$ext
package com.project.apirental.modules.subscription.api;

import com.project.apirental.modules.subscription.domain.SubscriptionPlanEntity;
import com.project.apirental.modules.subscription.repository.SubscriptionPlanRepository;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

@RestController
@RequestMapping("/api/subscriptions")
@RequiredArgsConstructor
@Tag(name = "Subscription Catalog", description = "Gestion du catalogue des plans")
@SecurityRequirement(name = "bearerAuth")
public class SubscriptionController {

    private final SubscriptionPlanRepository planRepository;

    @Operation(summary = "Lister tous les plans du catalogue")
    @GetMapping("/plans")
    public Flux<SubscriptionPlanEntity> getAllPlans() {
        return planRepository.findAll();
    }

    @Operation(summary = "Mettre Ã  jour les quotas d'un plan (Admin uniquement)")
    @PutMapping("/plans/{id}")
    @PreAuthorize("hasRole('ADMIN')") // Protection Admin pour le catalogue
    public Mono<ResponseEntity<SubscriptionPlanEntity>> updatePlan(
            @PathVariable UUID id, 
            @RequestBody SubscriptionPlanEntity planUpdate) {
        return planRepository.findById(id)
                .flatMap(existingPlan -> {
                    planUpdate.setId(existingPlan.getId());
                    return planRepository.save(planUpdate);
                })
                .map(ResponseEntity::ok)
                .switchIfEmpty(Mono.error(new RuntimeException("Plan non trouvÃ©")));
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\subscription\domain\PlanType.java
`$ext
package com.project.apirental.modules.subscription.domain;

/**
 * Ã‰numÃ©ration des types de plans de souscription disponibles.
 * UtilisÃ©e pour la validation des requÃªtes d'upgrade et la logique mÃ©tier.
 */
public enum PlanType {
    FREE,
    PRO,
    ENTERPRISE
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\subscription\domain\SubscriptionEntity.java
`$ext
package com.project.apirental.modules.subscription.domain;

import com.fasterxml.jackson.annotation.JsonIgnore;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.Transient;
import org.springframework.data.domain.Persistable;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table("subscriptions") // FIX : Pointer vers la table d'historique
public class SubscriptionEntity implements Persistable<UUID> {
    @Id
    private UUID id;
    private UUID organizationId;
    private String planType;
    private String status;
    private LocalDateTime startDate;
    private LocalDateTime endDate;

    @Transient
    @Builder.Default
    @JsonIgnore
    private boolean isNewRecord = false;

    @Override
    @Transient
    public boolean isNew() {
        return isNewRecord || id == null;
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\subscription\domain\SubscriptionPlanEntity.java
`$ext
package com.project.apirental.modules.subscription.domain;

import com.fasterxml.jackson.annotation.JsonIgnore;
import lombok.*;
import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.Transient;
import org.springframework.data.domain.Persistable;
import org.springframework.data.relational.core.mapping.Table;

import java.math.BigDecimal;
import java.util.UUID;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table("subscription_plans")
public class SubscriptionPlanEntity implements Persistable<UUID> {
    @Id
    private UUID id;
    private String name;
    private String description;
    private BigDecimal price;
    private Integer durationDays;
    private Integer maxVehicles;
    private Integer maxDrivers;
    private Integer maxAgencies;
    private Integer maxUsers;
    @Builder.Default
    private Boolean hasGeofencing = false;
    @Builder.Default
    private Boolean hasChat = false;

    @Transient
    @Builder.Default
    @JsonIgnore
    private boolean isNewRecord = false;

    @Override
    @Transient
    public boolean isNew() {
        return isNewRecord || id == null;
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\subscription\dto\PlanUpgradeRequest.java
`$ext
package com.project.apirental.modules.subscription.dto;

import com.project.apirental.modules.subscription.domain.PlanType;
import jakarta.validation.constraints.NotNull;

// Utilise l'Enum PlanType (FREE, PRO, ENTERPRISE)
public record PlanUpgradeRequest(
    @NotNull PlanType newPlan
) {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\subscription\dto\SubscriptionRemainingTimeDTO.java
`$ext
package com.project.apirental.modules.subscription.dto;

public record SubscriptionRemainingTimeDTO(
    long days,
    long hours,
    long minutes,
    String formattedTime,
    boolean isInfinite
) {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\subscription\dto\SubscriptionResponseDTO.java
`$ext
package com.project.apirental.modules.subscription.dto;

import java.math.BigDecimal;
import java.time.LocalDateTime;

public record SubscriptionResponseDTO(
    String planName,
    String description,
    BigDecimal price,
    Integer durationDays,
    Integer maxVehicles,
    Integer maxAgencies,
    LocalDateTime expiresAt,
    Boolean isExpired
) {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\subscription\listener\SubscriptionListener.java
`$ext
package com.project.apirental.modules.subscription.listener;

import com.project.apirental.shared.events.AuditEvent;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.event.EventListener;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Component;

@Component
@Slf4j
public class SubscriptionListener {
    @EventListener
    @Async
    public void onPlanChange(AuditEvent event) {
        if ("UPGRADE_PLAN".equals(event.action())) {
            log.info("ðŸš€ [QUOTA UPDATE] L'organisation a changÃ© de plan. DÃ©tails: {}", event.details());
        }
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\subscription\mapper\SubscriptionMapper.java
`$ext
package com.project.apirental.modules.subscription.mapper;

import com.project.apirental.modules.organization.domain.OrganizationEntity;
import com.project.apirental.modules.subscription.domain.SubscriptionPlanEntity;
import com.project.apirental.modules.subscription.dto.SubscriptionResponseDTO;
import org.springframework.stereotype.Component;
import java.time.LocalDateTime;

@Component
public class SubscriptionMapper {

    public SubscriptionResponseDTO toResponseDTO(OrganizationEntity org, SubscriptionPlanEntity plan) {
        boolean isExpired = org.getSubscriptionExpiresAt() != null && org.getSubscriptionExpiresAt().isBefore(LocalDateTime.now());
        
        return new SubscriptionResponseDTO(
                plan.getName(),
                plan.getDescription(),
                plan.getPrice(),
                plan.getDurationDays(),
                plan.getMaxVehicles(),
                plan.getMaxAgencies(),
                org.getSubscriptionExpiresAt(),
                isExpired
        );
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\subscription\repository\SubscriptionPlanRepository.java
`$ext
package com.project.apirental.modules.subscription.repository;

import com.project.apirental.modules.subscription.domain.SubscriptionPlanEntity;
import org.springframework.data.r2dbc.repository.R2dbcRepository;
import reactor.core.publisher.Mono;
import java.util.UUID;

public interface SubscriptionPlanRepository extends R2dbcRepository<SubscriptionPlanEntity, UUID> {
    Mono<SubscriptionPlanEntity> findByName(String name);
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\subscription\repository\SubscriptionRepository.java
`$ext
package com.project.apirental.modules.subscription.repository;

import com.project.apirental.modules.subscription.domain.SubscriptionEntity;
import org.springframework.data.r2dbc.repository.R2dbcRepository;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Repository
public interface SubscriptionRepository extends R2dbcRepository<SubscriptionEntity, UUID> {

    /**
     * RÃ©cupÃ¨re l'historique complet des souscriptions d'une organisation, 
     * de la plus rÃ©cente Ã  la plus ancienne.
     */
    Flux<SubscriptionEntity> findAllByOrganizationIdOrderByStartDateDesc(UUID organizationId);

    /**
     * RÃ©cupÃ¨re la souscription actuellement active pour une organisation.
     */
    Mono<SubscriptionEntity> findFirstByOrganizationIdAndStatus(UUID organizationId, String status);

    /**
     * RÃ©cupÃ¨re toutes les souscriptions d'un certain type (ex: pour des statistiques).
     */
    Flux<SubscriptionEntity> findAllByPlanType(String planType);
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\subscription\services\PaymentService.java
`$ext
package com.project.apirental.modules.subscription.services;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;
import java.time.Duration;

@Service
@Slf4j
public class PaymentService {

    /**
     * Simule un appel Ã  une passerelle de paiement (Stripe, etc.)
     */
    public Mono<Boolean> processPayment(String email, String planType, double amount) {
        log.info("ðŸ’³ Simulation du paiement pour {} (Plan: {}, Montant: {}XAF)", email, planType, amount);
        
        // Simule un dÃ©lai rÃ©seau de 800ms sans bloquer le thread
        return Mono.delay(Duration.ofMillis(800))
                .map(d -> {
                    log.info("âœ… Paiement validÃ© par la passerelle pour {}", email);
                    return true;
                });
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\modules\subscription\services\SubscriptionService.java
`$ext
package com.project.apirental.modules.subscription.services;

import com.project.apirental.modules.subscription.domain.SubscriptionEntity;
import com.project.apirental.modules.subscription.domain.SubscriptionPlanEntity;
import com.project.apirental.modules.subscription.dto.SubscriptionRemainingTimeDTO;
import com.project.apirental.modules.subscription.repository.SubscriptionPlanRepository;
import com.project.apirental.modules.subscription.repository.SubscriptionRepository;
import com.project.apirental.modules.organization.domain.OrganizationEntity;
import com.project.apirental.modules.organization.repository.OrganizationRepository;
import com.project.apirental.shared.events.AuditEvent;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import reactor.core.publisher.Mono;
import java.time.Duration;
import java.time.LocalDateTime;
import java.util.UUID;

@Service
@RequiredArgsConstructor
@Slf4j
public class SubscriptionService {

    private final SubscriptionPlanRepository planRepository;
    private final SubscriptionRepository subscriptionRepository; // FIX : Utiliser le bon type ici
    private final OrganizationRepository organizationRepository;
    private final PaymentService paymentService;
    private final ApplicationEventPublisher eventPublisher;

    @Transactional
    public Mono<Void> initializeDefaultSubscription(UUID organizationId) {
        return planRepository.findByName("FREE")
                .switchIfEmpty(Mono.error(new RuntimeException("Plan FREE non configurÃ©")))
                .flatMap(plan -> organizationRepository.findById(organizationId)
                        .flatMap(org -> {
                            // 1. Mise Ã  jour de l'Ã©tat de l'organisation
                            org.setSubscriptionPlanId(plan.getId());
                            org.setSubscriptionExpiresAt(null);
                            org.setSubscriptionAutoRenew(true);

                            // 2. CrÃ©ation de l'enregistrement historique
                            SubscriptionEntity subRecord = SubscriptionEntity.builder()
                                    .id(UUID.randomUUID())
                                    .organizationId(organizationId)
                                    .planType(plan.getName())
                                    .status("ACTIVE")
                                    .startDate(LocalDateTime.now())
                                    .isNewRecord(true)
                                    .build();

                            // 3. On chaÃ®ne les deux sauvegardes pour qu'elles s'exÃ©cutent
                            return organizationRepository.save(org)
                                    .then(subscriptionRepository.save(subRecord))
                                    .doOnSuccess(s -> log.info("âœ… Historique de souscription crÃ©Ã© pour l'org {}", organizationId));
                        }))
                .then();
    }

    @Transactional
    public Mono<SubscriptionPlanEntity> upgradePlan(UUID organizationId, String planName) {
        return planRepository.findByName(planName)
                .flatMap(plan -> organizationRepository.findById(organizationId)
                        .flatMap(org -> paymentService.processPayment(org.getEmail(), planName, plan.getPrice().doubleValue())
                                .flatMap(success -> {
                                        // --- LOGIQUE DE TEST : 2 MINUTES AU LIEU DE 30 JOURS ---
                                    LocalDateTime testExpiry = LocalDateTime.now().plusMinutes(2); 
                                    org.setSubscriptionPlanId(plan.getId());
                                     org.setSubscriptionExpiresAt(testExpiry);
                                //     org.setSubscriptionExpiresAt(LocalDateTime.now().plusDays(plan.getDurationDays()));
                                    
                                    SubscriptionEntity subRecord = SubscriptionEntity.builder()
                                            .id(UUID.randomUUID())
                                            .organizationId(organizationId)
                                            .planType(plan.getName())
                                            .status("ACTIVE")
                                            .startDate(LocalDateTime.now())
                                            .endDate(org.getSubscriptionExpiresAt())
                                            .isNewRecord(true)
                                            .build();

                                    return organizationRepository.save(org)
                                            .then(subscriptionRepository.save(subRecord))
                                            .thenReturn(plan);
                                })));
    }

    @Transactional
    public Mono<OrganizationEntity> checkAndDowngrade(OrganizationEntity org) {
        if (org.getSubscriptionExpiresAt() != null && org.getSubscriptionExpiresAt().isBefore(LocalDateTime.now())) {
            return planRepository.findByName("FREE")
                    .flatMap(freePlan -> {
                        org.setSubscriptionPlanId(freePlan.getId());
                        org.setSubscriptionExpiresAt(null);
                        
                        SubscriptionEntity history = SubscriptionEntity.builder()
                                .id(UUID.randomUUID())
                                .organizationId(org.getId())
                                .planType("FREE")
                                .status("AUTO_DOWNGRADE")
                                .startDate(LocalDateTime.now())
                                .isNewRecord(true)
                                .build();

                        return subscriptionRepository.save(history)
                                .then(organizationRepository.save(org));
                    });
        }
        return Mono.just(org);
    }

    public Mono<SubscriptionRemainingTimeDTO> getRemainingTime(UUID orgId) {
        return organizationRepository.findById(orgId)
                .flatMap(this::checkAndDowngrade)
                .map(org -> {
                    if (org.getSubscriptionExpiresAt() == null) {
                        return new SubscriptionRemainingTimeDTO(0, 0, 0, "IllimitÃ© (Plan FREE)", true);
                    }
                    Duration d = Duration.between(LocalDateTime.now(), org.getSubscriptionExpiresAt());
                    return new SubscriptionRemainingTimeDTO(d.toDays(), d.toHoursPart(), d.toMinutesPart(), 
                            d.toDays() + " jours restants", false);
                });
    }

    public Mono<SubscriptionEntity> createHistoryRecord(UUID organizationId, String planName, LocalDateTime endDate) {
        SubscriptionEntity history = SubscriptionEntity.builder()
                .id(UUID.randomUUID())
                .organizationId(organizationId)
                .planType(planName)
                .status("ACTIVE")
                .startDate(LocalDateTime.now())
                .endDate(endDate)
                .isNewRecord(true)
                .build();
                
        return subscriptionRepository.save(history);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\shared\config\CorsConfig.java
`$ext
package com.project.apirental.shared.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.reactive.CorsWebFilter;
import org.springframework.web.cors.reactive.UrlBasedCorsConfigurationSource;

import java.util.Arrays;

@Configuration
public class CorsConfig {

    @Bean
    public CorsWebFilter corsWebFilter() {
        CorsConfiguration corsConfig = new CorsConfiguration();
        // Autoriser votre frontend (ex: React sur localhost:3000)
        corsConfig.setAllowedOrigins(Arrays.asList("http://localhost:3000", "http://localhost:3001", "http://localhost:3002","http://localhost:3003", "https://votre-app.vercel.app"));
        corsConfig.setMaxAge(3600L);
        corsConfig.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        corsConfig.setAllowedHeaders(Arrays.asList("Content-Type", "Authorization", "x-requested-with"));
        corsConfig.setAllowCredentials(true);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", corsConfig);

        return new CorsWebFilter(source);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\shared\events\AuditEvent.java
`$ext
package com.project.apirental.shared.events;

public record AuditEvent(String action, String module, String details) {}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\shared\exceptions\GlobalExceptionHandler.java
`$ext
package com.project.apirental.shared.exceptions;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import reactor.core.publisher.Mono;

@RestControllerAdvice
public class GlobalExceptionHandler {

    // Capture les RuntimeException (ex: "Email already exists") et renvoie 400 Bad Request
    @ExceptionHandler(RuntimeException.class)
    public Mono<ResponseEntity<ErrorResponse>> handleRuntimeException(RuntimeException ex) {
        return Mono.just(
                ResponseEntity.status(HttpStatus.BAD_REQUEST)
                        .body(new ErrorResponse(HttpStatus.BAD_REQUEST.value(), ex.getMessage()))
        );
    }

    // Capture toutes les autres erreurs non gÃ©rÃ©es -> 500
    @ExceptionHandler(Exception.class)
    public Mono<ResponseEntity<ErrorResponse>> handleGeneralException(Exception ex) {
        return Mono.just(
                ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                        .body(new ErrorResponse(HttpStatus.INTERNAL_SERVER_ERROR.value(), "Une erreur interne est survenue: " + ex.getMessage()))
        );
    }

    // Petit DTO interne pour formater l'erreur proprement
    public record ErrorResponse(int status, String message) {}
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\shared\security\JwtAuthenticationFilter.java
`$ext
package com.project.apirental.shared.security;

import org.springframework.http.HttpHeaders;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.ReactiveSecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import org.springframework.web.server.WebFilter;
import org.springframework.web.server.WebFilterChain;
import reactor.core.publisher.Mono;

import java.util.Collections;

@Component
public class JwtAuthenticationFilter implements WebFilter {

    private final JwtUtil jwtUtil;

    public JwtAuthenticationFilter(JwtUtil jwtUtil) {
        this.jwtUtil = jwtUtil;
    }

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, WebFilterChain chain) {
        String authHeader = exchange.getRequest().getHeaders().getFirst(HttpHeaders.AUTHORIZATION);

        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            String token = authHeader.substring(7);

            if (jwtUtil.validateToken(token)) {
                String username = jwtUtil.getUsernameFromToken(token);
                String role = jwtUtil.getRoleFromToken(token);

                // Spring attend souvent ROLE_ avant le nom du rÃ´le pour hasRole()
                UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken(
                        username,
                        null,
                        Collections.singletonList(new SimpleGrantedAuthority("ROLE_" + role))
                );

                return chain.filter(exchange)
                        .contextWrite(ReactiveSecurityContextHolder.withAuthentication(auth));
            }
        }
        return chain.filter(exchange);
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\shared\security\JwtUtil.java
`$ext
package com.project.apirental.shared.security;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import java.security.Key;
import java.util.Date;
import java.util.Base64;
import java.util.function.Function;

@Component
public class JwtUtil {

    @Value("${jwt.secret}")
    private String secret;

    @Value("${jwt.expiration}")
    private long expiration;

    private Key getSignKey() {
        byte[] keyBytes = Base64.getDecoder().decode(secret);
        return Keys.hmacShaKeyFor(keyBytes);
    }

    public String generateToken(String username, String role) {
        return Jwts.builder()
                .setSubject(username)
                .claim("role", role)
                .setIssuedAt(new Date(System.currentTimeMillis()))
                .setExpiration(new Date(System.currentTimeMillis() + expiration))
                .signWith(getSignKey(), SignatureAlgorithm.HS256)
                .compact();
    }

    public String getUsernameFromToken(String token) {
        return extractClaim(token, Claims::getSubject);
    }

    public String getRoleFromToken(String token) {
        return extractAllClaims(token).get("role", String.class);
    }

    public <T> T extractClaim(String token, Function<Claims, T> claimsResolver) {
        final Claims claims = extractAllClaims(token);
        return claimsResolver.apply(claims);
    }

    private Claims extractAllClaims(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(getSignKey())
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    public boolean validateToken(String token) {
        try {
            Jwts.parserBuilder().setSigningKey(getSignKey()).build().parseClaimsJws(token);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\java\com\project\apirental\shared\utils\explication.md
`$ext
#### Cette dossier a pour but de mettre les fichier lie aux utilitaires 

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\main\resources\application.properties
`$ext
# ==============================================================
# Server port
# ==============================================================
server.port=8081

spring.application.name=apirental

# ==============================================================
# Configuration R2DBC (RÃ©actif - Pour l'application)
# ==============================================================
spring.r2dbc.url=r2dbc:postgresql://dpg-d55b70mmcj7s73f8s7f0-a.oregon-postgres.render.com:5432/rental_db_5bd2
spring.r2dbc.username=brayanne
spring.r2dbc.password=VuyLTYYghOaai8i3FDKznqoBpadB0Qcu
spring.r2dbc.properties.ssl=true

# ==============================================================
# Configuration Liquibase (JDBC - Pour la migration au dÃ©marrage)
# ==============================================================
spring.liquibase.enabled=true
spring.liquibase.change-log=classpath:db/changelog/db.changelog-master.xml
# URL JDBC explicite obligatoire pour que Liquibase fonctionne sans R2DBC
# DB_SSL_PARAM doit valoir "?sslmode=require" sur Render, ou "?sslmode=disable" en local
spring.liquibase.url=jdbc:postgresql://dpg-d55b70mmcj7s73f8s7f0-a.oregon-postgres.render.com:5432/rental_db_5bd2?sslmode=require
spring.liquibase.user=brayanne
spring.liquibase.password=VuyLTYYghOaai8i3FDKznqoBpadB0Qcu
spring.liquibase.driver-class-name=org.postgresql.Driver

# ==============================================================
# Configuration Swagger (SpringDoc)
# ==============================================================
springdoc.api-docs.enabled=true
springdoc.swagger-ui.enabled=true
springdoc.swagger-ui.path=/swagger-ui.html

# ==============================================================
# Configuration WebFlux
# ==============================================================
spring.webflux.base-path=/

# ==============================================================
# Configuration JWT
# ==============================================================
# ClÃ© secrÃ¨te (gÃ©nÃ©rez-en une forte pour la prod via la variable JWT_SECRET)
jwt.secret=${JWT_SECRET:7KyhCtwGUvIoqcxTCabQGm3FJ/F6LfCy9nmOg3hy+WA=}
jwt.expiration=86400000

# ==============================================================
# Configuration MEDIA
# ==============================================================
# Dossier oÃ¹ les fichiers seront stockÃ©s
application.file.upload-dir=uploads
# URL de base pour construire le lien public
application.base-url=http://localhost:8080

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\src\test\java\com\project\apirental\ApirentalApplicationTests.java
`$ext
package com.project.apirental;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class ApirentalApplicationTests {

	@Test
	void contextLoads() {
	}

}

---
### Fichier : D:\Ecole\HASSANA 5GI 2025_2026\traffic réseau\apiRental5GI\uploads\hzm_0c11eb35.md
`$ext
# Service d'Authentification & RBAC (Auth Service)

Ce projet est un microservice d'authentification robuste, sÃ©curisÃ© et prÃªt pour la production. Il implÃ©mente une gestion complÃ¨te des identitÃ©s avec **JWT (JSON Web Tokens)** et un contrÃ´le d'accÃ¨s basÃ© sur les rÃ´les (**RBAC**) et les permissions granulaires.

Le projet est construit selon les principes de l'**Architecture Hexagonale (Ports & Adapters)** pour assurer une sÃ©paration stricte entre la logique mÃ©tier (Domaine) et les dÃ©tails techniques (Framework, Base de donnÃ©es, API).

## ðŸš€ FonctionnalitÃ©s ClÃ©s

- **Authentification Flexible** : Connexion via nom d'utilisateur, email ou numÃ©ro de tÃ©lÃ©phone.
- **SÃ©curitÃ© JWT** :
  - **Access Token** : DurÃ©e de vie courte (signÃ© HS256).
  - **Refresh Token** : DurÃ©e de vie longue, stockÃ© en base de donnÃ©es.
  - **Rotation des Refresh Tokens** : SÃ©curitÃ© accrue (un refresh token ne peut Ãªtre utilisÃ© qu'une seule fois).
- **RBAC & Permissions** : Gestion fine des droits (ex: `ROLE_ADMIN` possÃ¨de `user:create`, `report:read`).
- **Architecture Hexagonale** : Le cÅ“ur du mÃ©tier est isolÃ© de Spring Boot et de la BDD.
- **Migrations de Base de DonnÃ©es** : Versionnage du schÃ©ma SQL via **Liquibase**.
- **Documentation API** : IntÃ©gration native de **Swagger UI / OpenAPI**.
- **Docker Ready** : Conteneurisation optimisÃ©e pour le dÃ©ploiement cloud.

---

## ðŸ›  Stack Technique

- **Langage** : Java 21
- **Framework** : Spring Boot 3.5.8
- **SÃ©curitÃ©** : Spring Security 6, JJWT (Java JWT)
- **Base de donnÃ©es** :  17
- **ORM** : Spring Data JPA / Hibernate
- **Migration** : Liquibase
- **Documentation** : SpringDoc (Swagger UI)
- **Build** : Maven

---

## ðŸ— Architecture du Projet

Le projet suit une structure de dossiers reflÃ©tant l'architecture hexagonale :

```text
src/main/java/com/tramasys/auth
â”œâ”€â”€ adapters
â”‚   â”œâ”€â”€ in/web          # ContrÃ´leurs REST (Points d'entrÃ©e)
â”‚   â””â”€â”€ out/persistence # ImplÃ©mentation des Repositories (JPA/SQL)
â”œâ”€â”€ application
â”‚   â”œâ”€â”€ dto             # Objets de transfert de donnÃ©es (Request/Response)
â”‚   â””â”€â”€ service         # Orchestration des cas d'utilisation (Logique applicative)
â”œâ”€â”€ config              # Configuration Spring (Security, Cors, Swagger)
â”œâ”€â”€ domain
â”‚   â”œâ”€â”€ exception       # Exceptions mÃ©tier
â”‚   â”œâ”€â”€ model           # EntitÃ©s pures du domaine (User, Role, Token)
â”‚   â””â”€â”€ port            # Interfaces (Ports In/Out) dÃ©finissant les contrats
â””â”€â”€ util                # Utilitaires (JwtUtil, UserContext)
```

## ðŸ“– Documentation API (Swagger)

Toute la documentation dÃ©taillÃ©e des endpoints (paramÃ¨tres, corps JSON, codes de rÃ©ponse) est gÃ©nÃ©rÃ©e automatiquement et accessible via une interface web interactive.
Une fois l'application lancÃ©e, accÃ©dez Ã  :

```bash
http://localhost:8080/swagger-ui.html
```

### Comment tester dans Swagger ?

- Utilisez l'endpoint POST /api/auth/login pour obtenir un token.
- Copiez l'accessToken de la rÃ©ponse.
- Cliquez sur le bouton Authorize (cadenas) en haut de la page Swagger.
- Entrez le token sous la forme : Bearer VOTRE_TOKEN_ICI.
- Vous pouvez maintenant tester les routes protÃ©gÃ©es (ex: /api/auth/me).

## âš™ï¸ Installation et DÃ©marrage

### PrÃ©requis

- Java 21 (JDK)
- PostgreSQL (Local ou Docker)
- Maven (Le wrapper mvnw est inclus)

### 1. Configuration de la Base de DonnÃ©es

Assurez-vous d'avoir une instance PostgreSQL qui tourne.
Par dÃ©faut, l'application attend :
DB Name : authdb
User : auth_user
Password : auth_pass
Pour lancer une BDD rapidement via Docker :

```bash
docker run --name auth-db -e POSTGRES_USER=auth_user -e POSTGRES_PASSWORD=auth_pass -e POSTGRES_DB=authdb -p 5432:5432 -d postgres:alpine
```

### 2. Lancement en local

Clonez le projet et lancez-le via le wrapper Maven :

```bash
git clone https://github.com/votre-utilisateur/auth_service.git
cd auth_service
```

# Compiler et lancer

```bash
./mvnw spring-boot:run
```

L'application sera accessible sur http://localhost:8080.

## ðŸ³ DÃ©ploiement avec Docker

Le projet inclut un Dockerfile optimisÃ© (Multi-stage build).

### 1. Construire l'image

```bash
docker build -t auth-service .
```

### 2. Lancer le conteneur

Vous pouvez surcharger les variables d'environnement au dÃ©marrage pour la production :

```bash
docker run -d -p 8080:8080 \
  -e DB_USER=mon_user_prod \
  -e DB_PASSWORD=mon_password_prod \
  -e SPRING_DATASOURCE_URL=jdbc:postgresql://mon-serveur-db:5432/authdb \
  -e AUTH_JWT_SECRET=MA_CLE_SECRETE_TRES_LONGUE_ET_SECURISEE \
  --name auth-service-container \
  auth-service
```

## ðŸ”‘ Variables d'Environnement

Voici les variables clÃ©s Ã  configurer, notamment pour le dÃ©ploiement (DigitalOcean, AWS, etc.) :
|Variable | Description | Valeur par dÃ©faut (Dev) |
|---------|--------------|-------------------------|
SPRING_DATASOURCE_URL | URL de connexion JDBC | jdbc:postgresql://localhost:5432/authdb |
DB_USER | Utilisateur BDD | ROOT_USERNAME ("postgres" par dÃ©faut) |
DB_PASSWORD | Mot de passe BDD | ROOT_PASSWORD |
AUTH_JWT_SECRET | ClÃ© secrÃ¨te de signature (min 32 chars) | (Une clÃ© par dÃ©faut est fournie pour le dev) |
SERVER_PORT | Port d'Ã©coute du serveur | 8080 |

## ðŸ›¡ SÃ©curitÃ©

Mots de passe : HachÃ©s avec BCrypt avant stockage.
Stateless : Aucune session HTTP n'est stockÃ©e cÃ´tÃ© serveur.
Protection CSRF : DÃ©sactivÃ©e (inutile pour une API REST stateless).
CORS : Configurable via CorsConfig (par dÃ©faut permissif pour le dÃ©veloppement, Ã  restreindre en production).

## ðŸ‘¤ Auteurs

Projet dÃ©veloppÃ© par Brayan KUATE pour TraMaSys.

